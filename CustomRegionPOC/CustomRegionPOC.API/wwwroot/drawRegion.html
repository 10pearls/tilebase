<!DOCTYPE html>
<html>
<head>
    <title>Tile Base</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <style>
        #map {
            height: 100%;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
</head>
<body>
        <div id="map"></div>
        <!--<script src="https://maps.googleapis.com/maps/api/js"></script>-->
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCPwkFRPrwauZKWfskQ9FcyieUWd_-VALM&libraries=drawing"></script>
        
        
<script>
// geohash.js
// Geohash library for Javascript
// (c) 2008 David Troy
// Distributed under the MIT License

BITS = [16, 8, 4, 2, 1];

BASE32 = 											   "0123456789bcdefghjkmnpqrstuvwxyz";
NEIGHBORS = { right  : { even :  "bc01fg45238967deuvhjyznpkmstqrwx" },
							left   : { even :  "238967debc01fg45kmstqrwxuvhjyznp" },
							top    : { even :  "p0r21436x8zb9dcf5h7kjnmqesgutwvy" },
							bottom : { even :  "14365h7k9dcfesgujnmqp0r2twvyx8zb" } };
BORDERS   = { right  : { even : "bcfguvyz" },
							left   : { even : "0145hjnp" },
							top    : { even : "prxz" },
							bottom : { even : "028b" } };

NEIGHBORS.bottom.odd = NEIGHBORS.left.even;
NEIGHBORS.top.odd = NEIGHBORS.right.even;
NEIGHBORS.left.odd = NEIGHBORS.bottom.even;
NEIGHBORS.right.odd = NEIGHBORS.top.even;

BORDERS.bottom.odd = BORDERS.left.even;
BORDERS.top.odd = BORDERS.right.even;
BORDERS.left.odd = BORDERS.bottom.even;
BORDERS.right.odd = BORDERS.top.even;

function refine_interval(interval, cd, mask) {
	if (cd&mask)
		interval[0] = (interval[0] + interval[1])/2;
  else
		interval[1] = (interval[0] + interval[1])/2;
}

function calculateAdjacent(srcHash, dir) {
	srcHash = srcHash.toLowerCase();
	var lastChr = srcHash.charAt(srcHash.length-1);
	var type = (srcHash.length % 2) ? 'odd' : 'even';
	var base = srcHash.substring(0,srcHash.length-1);
	if (BORDERS[dir][type].indexOf(lastChr)!=-1)
		base = calculateAdjacent(base, dir);
	return base + BASE32[NEIGHBORS[dir][type].indexOf(lastChr)];
}

function decodeGeoHash(geohash) {
	var is_even = 1;
	var lat = []; var lon = [];
	lat[0] = -90.0;  lat[1] = 90.0;
	lon[0] = -180.0; lon[1] = 180.0;
	lat_err = 90.0;  lon_err = 180.0;
	
	for (i=0; i<geohash.length; i++) {
		c = geohash[i];
		cd = BASE32.indexOf(c);
		for (j=0; j<5; j++) {
			mask = BITS[j];
			if (is_even) {
				lon_err /= 2;
				refine_interval(lon, cd, mask);
			} else {
				lat_err /= 2;
				refine_interval(lat, cd, mask);
			}
			is_even = !is_even;
		}
	}
	lat[2] = (lat[0] + lat[1])/2;
	lon[2] = (lon[0] + lon[1])/2;

	return { latitude: lat, longitude: lon};
}

function encodeGeoHash(latitude, longitude) {
	var is_even=1;
	var i=0;
	var lat = []; var lon = [];
	var bit=0;
	var ch=0;
	var precision = 12;
	geohash = "";

	lat[0] = -90.0;  lat[1] = 90.0;
	lon[0] = -180.0; lon[1] = 180.0;
	
	while (geohash.length < precision) {
	  if (is_even) {
			mid = (lon[0] + lon[1]) / 2;
	    if (longitude > mid) {
				ch |= BITS[bit];
				lon[0] = mid;
	    } else
				lon[1] = mid;
	  } else {
			mid = (lat[0] + lat[1]) / 2;
	    if (latitude > mid) {
				ch |= BITS[bit];
				lat[0] = mid;
	    } else
				lat[1] = mid;
	  }

		is_even = !is_even;
	  if (bit < 4)
			bit++;
	  else {
			geohash += BASE32[ch];
			bit = 0;
			ch = 0;
	  }
	}
	return geohash;
}

</script>

<script>
    var coordinates = [];
    var markers = [];
    var map;
    var drawingManager;
    var tilelayer;
    var rectangle;
    var infoWindow;

            var initialBounds = {
          north: 38.99209160356612,
          south: 38.976092526039,
          east: -77.08265178826906,
          west: -77.10591915277098
        };

        var boundingBoxCoordinates = $.extend({}, initialBounds);

        function showNewRect(event) {
            var ne = rectangle.getBounds().getNorthEast();
            var sw = rectangle.getBounds().getSouthWest();

            var contentString = '<b>Rectangle moved.</b><br>' +
                'New north-east corner: ' + ne.lat() + ', ' + ne.lng() + '<br>' +
                'New south-west corner: ' + sw.lat() + ', ' + sw.lng();


            boundingBoxCoordinates.north = ne.lat();
            boundingBoxCoordinates.east = ne.lng();
            boundingBoxCoordinates.south = sw.lat();
            boundingBoxCoordinates.west = sw.lng();

            // Set the info window's content and position.
            infoWindow.setContent(contentString);
            infoWindow.setPosition(ne);

            infoWindow.open(map);
        }

        function postAjax(url, data, success) {

            var xhr = new XMLHttpRequest();
            xhr.open('POST', url);
            xhr.onreadystatechange = function () {
                if (xhr.readyState > 3 && xhr.status == 200) {
                    success(xhr.responseText);
                }
            };
            xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');

            //xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
            xhr.send(JSON.stringify(data));
            return xhr;
        }

        function getAjax(url, success) {
            var xhr = window.XMLHttpRequest ? new XMLHttpRequest() : new ActiveXObject('Microsoft.XMLHTTP');
            xhr.open('GET', url);
            xhr.onreadystatechange = function () {
                if (xhr.readyState > 3 && xhr.status == 200) success(xhr.responseText);
            };
            xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
            xhr.send();
            return xhr;
        }

        function newMap() {
            return new google.maps.Map(document.getElementById('map'), {
                center: { lat: 38.984653, lng: -77.094711 },
                zoom: 15
            });
        }


        function TileToQuadKey(x, y, zoom) {
            var quad = "";
            for (var i = zoom; i > 0; i--) {
                var mask = 1 << (i - 1);
                var cell = 0;
                if ((x & mask) != 0)
                    cell++;
                if ((y & mask) != 0)
                    cell += 2;
                quad += cell;
            }
            return quad;
        }

        tilelayer = new google.maps.ImageMapType({
            getTileUrl: function (tile, zoom) {
                var imageurl3 = "http://chart.apis.google.com/chart?chst=d_text_outline&chs=512x512&chf=bg,s,ff000044&chld=FFFFFF|32|h|000000|b|";
                var imageurl4 = "http://chart.apis.google.com/chart?chst=d_text_outline&chs=512x512&chf=bg,s,ffffff00&chld=FFFFFF|32|h|000000|b|";
                var tilegoogle = " (" + tile.x + "," + tile.y + ")";
                //var tiletms = " (" + tile.x + "," + ((1 << zoom) - tile.y - 1) + ")";
                //var tilequadtree = " " +TileToQuadKey( tile.x, tile.y, zoom);

                if (tile.x < 0 || tile.y < 0) return "http://chart.apis.google.com/chart?chst=d_text_outline&chs=512x512&chf=bg,s,ffffff99&chld=FFFFFF|32|h|000000|b|";
                if (tile.x >= (1 << zoom) || tile.y >= (1 << zoom)) return "http://chart.apis.google.com/chart?chst=d_text_outline&chs=512x512&chf=bg,s,ffffff99&chld=FFFFFF|32|h|000000|b|";

                if ((tile.x % 2 && !(tile.y % 2)) || (!(tile.x % 2) && tile.y % 2)) {
                    imageurl = imageurl3;
                } else {
                    imageurl = imageurl4;
                }
                return imageurl + "||||Google: " + tilegoogle + "|Zoom " + zoom + "||||||____________________________";
            },
            tileSize: new google.maps.Size(256, 256),
            opacity: 0.3,
        });

        function onOverlayComplete(e) {
            console.log(e);

            var locations = e.overlay.getPath().getArray();
            coordinates = [];

            for (var i = 0; i < locations.length; i++) {
                var lat = locations[i].lat();
                var lng = locations[i].lng();
                coordinates.push({ lat: lat, lng: lng });
            }

        }

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 38.984653, lng: -77.094711 },
                zoom: 15
            });

            drawingManager = new google.maps.drawing.DrawingManager({
                drawingMode: google.maps.drawing.OverlayType.POLYGON,
                drawingControl: true,
                drawingControlOptions: {
                    position: google.maps.ControlPosition.TOP_CENTER,
                    drawingModes: ['polygon']
                },
                markerOptions: { icon: 'https://developers.google.com/maps/documentation/javascript/examples/full/images/beachflag.png' },
                circleOptions: {
                    fillColor: '#FF0000',
                    fillOpacity: 1,
                    strokeWeight: 5,
                    clickable: false,
                    editable: true,
                    zIndex: 1
                }
            });

            google.maps.event.addListener(drawingManager, 'overlaycomplete', onOverlayComplete);

            // Define the rectangle and set its editable property to true.
            rectangle = new google.maps.Rectangle({
                bounds: initialBounds,
                editable: true,
                draggable: true
            });

            map = newMap();
            map.overlayMapTypes.insertAt(0, tilelayer);
            drawingManager.setMap(map);
            var opt = { minZoom: 10 };
            map.setOptions(opt);

            rectangle.setMap(map);

            // Add an event listener on the rectangle.
            rectangle.addListener('bounds_changed', showNewRect);

            infoWindow = new google.maps.InfoWindow();
        }

        initMap();

        function resetRegions(resetBoundingBox) {
            coordinates = [];
            map = newMap();
            map.overlayMapTypes.insertAt(0, tilelayer);
            drawingManager.setMap(map);
            var opt = { minZoom: 10, disableDoubleClickZoom: false };
            map.setOptions(opt);


            if (resetBoundingBox) {
                rectangle.setMap(null);

                rectangle = new google.maps.Rectangle({
                    bounds: initialBounds,
                    editable: true,
                    draggable: true
                });
            }

            rectangle.setMap(map);

            // Add an event listener on the rectangle.
            rectangle.addListener('bounds_changed', showNewRect);

            $("#DynamoStats").text("");
            $("#propertyCount").text("");
        }

        function getCustomRegionProperties(boundingBox, coordinates, areaName, beds, bathsFull, bathsHalf) {
            if (!coordinates.length) {
                alert("Please draw a region");
                throw new Error("area name needed");
            }

            var obj = {
                areaName: areaName,
                points: coordinates
            }

            var boundingBoxCoordinatesQueryParams = `north=${boundingBoxCoordinates.north}`;
            boundingBoxCoordinatesQueryParams += `&east=${boundingBoxCoordinates.east}`;
            boundingBoxCoordinatesQueryParams += `&south=${boundingBoxCoordinates.south}`;
            boundingBoxCoordinatesQueryParams += `&west=${boundingBoxCoordinates.west}`;

            var queryParams = "&beds=" + beds + "&bathsFull=" + bathsFull + "&bathsHalf=" + bathsHalf;

            var url = '/api/customregion/GetListings';
            url += '?';

            if (boundingBox) {
                url += boundingBoxCoordinatesQueryParams;
            }

            url += queryParams;
            console.log(url);

            postAjax(url, obj, function (data) {
                var resp = JSON.parse(data);
                coordinates = [];
                for (var i = 0; i < resp.length; i++) {

                    var markerLatLng = { lat: resp[i].lat, lng: resp[i].lng };
                    var marker = new google.maps.Marker({
                        position: markerLatLng,
                        map: map,
                        title: "HELLO"
                    });
                    markers.push(marker);

                    // function markerOnClickEvent(marker) {

                    //     var infoWindow = new google.maps.InfoWindow({
                    //         content: marker.title
                    //     });
                    //     infoWindow.open(map, marker);
                    // }

                    // google.maps.event.addListener(marker, 'click', markerOnClickEvent(marker));
                }

            });
        }

        function saveRegion(coordinates, areaName, beds, bathsFull, bathsHalf) {
            if (!coordinates.length) {
                alert("Please draw a region");
                throw new Error("draw region");
            }
            if (!areaName) {
                alert("Please give a area name");
                throw new Error("area name needed");
            }

            var obj = {
                areaName: areaName,
                points: coordinates,
                beds: beds,
                bathsFull: bathsFull,
                bathsHalf: bathsHalf
            }

            postAjax('/api/customregion/', obj, function (data) {
                var resp = JSON.parse(data);

                //poly.setMap(map);
                coordinates = [];
                debugger;
                for (var i = 0; i < resp.length; i++) {

                    var markerLatLng = { lat: resp[i].lat, lng: resp[i].lng };
                    var marker = new google.maps.Marker({
                        position: markerLatLng,
                        map: map,
                        title: resp[i].name
                    });
                    markers.push(marker);

                    //function markerOnClickEvent(marker) {

                    //    var infoWindow = new google.maps.InfoWindow({
                    //        content: marker.title
                    //    });
                    //    infoWindow.open(map, marker);
                    //}

                    //google.maps.event.addListener(marker, 'click', markerOnClickEvent(marker));
                }

                //console.log(JSON.parse(data));
            });

        }

    </script>
    <button onclick="resetRegions(true)">Reset regions</button>
    <span id="queryCount" style="color:red;font-size:large;background-color:aqua"></span> <br />
    <span id="propertyCount" style="color:red;font-size:large;background-color:aqua"></span> <br />
    <table>
        <tr>
            <td>
                Name:
            </td>
            <td>
                <input type="text" name="areaName" , id="areaName">
            </td>
            <td>
                Beds:
            </td>
            <td>
                <select class="form-control select2" id="beds">
                    <option value="" selected>Select</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                </select>
            </td>
            <td>
                Baths Full:
            </td>
            <td>
                <select class="form-control select2" id="bathsFull">
                    <option value="" selected>Select</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                </select>
            </td>
            <td>
                Baths Half:
            </td>
            <td>
                <select class="form-control select2" id="bathsHalf">
                    <option value="" selected>Select</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                </select>
            </td>
            <td colspan="2">
                <button onclick="getCustomRegionProperties(
            false,
            coordinates,
            document.getElementById('areaName').value,
            document.getElementById('beds').value,
            document.getElementById('bathsFull').value,
            document.getElementById('bathsHalf').value
            )">
                    Get Custom Region Properties
                </button>
                <button onclick="getCustomRegionProperties(
                true,
                coordinates,
                document.getElementById('areaName').value,
                document.getElementById('beds').value,
                document.getElementById('bathsFull').value,
                document.getElementById('bathsHalf').value
                )">
                    Get Custom Region Properties By Bounding Box
                </button>
                <button onclick="saveRegion(
                coordinates,
                document.getElementById('areaName').value,
                document.getElementById('beds').value,
                document.getElementById('bathsFull').value,
                document.getElementById('bathsHalf').value
                )">
                    Save Region
                </button>
            </td>
        </tr>
    </table>
</body>
</html>